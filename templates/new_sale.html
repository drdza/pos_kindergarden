{% extends "base.html" %}
{% block title %}Nueva Venta{% endblock %}
{% block head %}
<!-- Estilos adicionales espec√≠ficos para esta p√°gina -->
{% endblock %}
{% block content %}
<div class="card">
  <h2>Registrar Venta</h2>
  <form method="post" action="{{ url_for('create_sale') }}" id="sale-form">
    
    <div class="card">
      <div class="row">      
          <div class="form-group">
            <label class="form-label" for="customer-select">Alumno</label>
            <select name="customer_id" id="customer-select" class="form-select select2-busqueda">
              <option value="">-- Selecciona Alumno --</option>
              {% for c in customers %}
              <option value="{{ c.id }}" 
                      data-name="{{ c.name }}" 
                      data-enrollment="{{ c.enrollment }}">
                {{ "%05d"|format(c.enrollment|int) }} - {{ c.name }}
              </option>
              {% endfor %}
            </select>
            <input type="hidden" name="customer_name" id="customer-name">
            <input type="hidden" name="customer_enrollment" id="customer-enrollment">
          </div>
        
          <div class="form-group">
            <label class="form-label" for="seller-select">Vendedor</label>
            <select name="seller_id" id="seller-select" class="form-select select2-busqueda">
              <option value="">-- Selecciona Vendedor --</option>
              {% for s in sellers %}
              <option value="{{ s.id }}" data-name="{{ s.first_name }} {{ s.second_name }}">
                {{ s.first_name }} {{ s.second_name }}
              </option>
              {% endfor %}
            </select>
            <input type="hidden" name="seller_name" id="seller-name">
          </div>      
      </div>    

      <div class="form-group">
        <label class="form-label" for="product-search">Buscar Producto</label>
        <div class="search-container">
          <input type="text" 
                id="product-search" 
                name="txt" 
                placeholder="üîç Buscar por SKU o descripci√≥n..."
                hx-get="{{ url_for('api_products_search') }}"
                hx-target="#search-results"
                hx-trigger="keyup changed delay:250ms"
                hx-indicator="#search-spinner"
                autocomplete="off"
                class="search-input">
          <div class="search-indicator" id="search-spinner"></div>
        </div>
      </div>
  
      <div id="search-results" class="search-results-card"></div>
    </div>

    <div class="card">
      <h3>Detalle de Venta</h3>
      <table id="items-table">
        <thead>
          <tr>
            <th>SKU</th>
            <th>Descripci√≥n</th>            
            <th class="right">Cantidad</th>
            <th class="right">Precio</th>
            <th class="right">IVA</th>
            <th class="right">Importe</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="items-body">
          <!-- filas -->
        </tbody>
      </table>
    </div>

    <div class="card" style="flex:1">
      <h3>Pago</h3>
    
      <div class="row">
        <div class="form-group" style="min-width: 180px;">
          <label class="form-label" for="payment-method">M√©todo</label>
          <select id="payment-method" name="payment_method" class="form-select">
            <option value="CASH">Efectivo</option>
            <option value="CARD">Tarjeta</option>
            <option value="TRANSFER">Transferencia</option>
          </select>
        </div>
    
        <div class="form-group" style="min-width: 160px;">
          <label class="form-label" for="payment-amount">Monto Recibido</label>
          <input id="payment-amount" class="right" type="number" step="0.01"
                 name="payment_amount" placeholder="Monto aplicado">
        </div>
    
        <!-- NUEVO: aplica solo una parte (se muestra bajo demanda) -->
        <div class="form-group" style="min-width: 160px;">
          <label class="form-label" style="display:flex; gap:8px; align-items:center;">
            <input id="apply-partial" type="checkbox" />
            Aplicar solo una parte
          </label>

          <input id="payment-apply" class="right" type="number" step="0.01"
                name="payment_apply" placeholder="Monto a aplicar"
                style="display:none;">
        </div>
      </div>
    </div>
    
    <!-- En la tarjeta Totales puedes opcionalmente mostrar el cambio -->
    <div class="card" style="flex:1">
      <h3>Totales</h3>
      <div class="row"><div>Subtotal</div><div class="right" id="t-subtotal">0.00</div></div>
      <div class="row"><div>IVA</div><div class="right" id="t-tax">0.00</div></div>
      <div class="row"><div><strong>Total</strong></div><div class="right" id="t-total"><strong>0.00</strong></div></div>
      <!-- NUEVO: vista previa del cambio (solo visual) -->
      <div class="row" id="row-change" style="display:none;">
        <div>Cambio</div><div class="right" id="t-change">0.00</div>
      </div>
    </div>
    

    <div class="row">
      <button class="btn">Guardar e imprimir</button>
      <a class="btn secondary" href="{{ url_for('new_sale') }}">Limpiar</a>
    </div>

    <!-- campos de arrays -->
    <div id="hidden-arrays"></div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<!-- El JavaScript est√° en sales.js -->
{% endblock %}