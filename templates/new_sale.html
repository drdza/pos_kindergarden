{% extends "base.html" %}
{% block title %}Nueva venta{% endblock %}
{% block head %}
<!-- Estilos adicionales espec칤ficos para esta p치gina -->
{% endblock %}
{% block content %}
<div class="card">
  <h2>Registrar Venta</h2>
  <form method="post" action="{{ url_for('create_sale') }}" id="sale-form">
    
    <div class="row">
      
      <div class="form-group">
        <label class="form-label">Alumno</label>
        <select name="customer_id" id="customer-select" class="form-select select2-busqueda">
          <option value="">-- Selecciona Alumno --</option>
          {% for c in customers %}
          <option value="{{ c.id }}" data-name="{{ c.name }}" data-enrollment="{{ c.enrollment }}">
            {{ "%05d"|format(c.enrollment|int) }} - {{ c.name }}
          </option>
          {% endfor %}
        </select>
        <input type="hidden" name="customer_name" id="customer-name">
        <input type="hidden" name="customer_enrollment" id="customer-enrollment">
      </div>
      
      <div class="form-group">
        <label class="form-label">Vendedor</label>
        <select name="seller_id" id="seller-select" class="form-select select2-busqueda">
          <option value="">-- Selecciona Vendedor --</option>
          {% for s in sellers %}
          <option value="{{ s.id }}" data-name="{{ s.first_name }} {{ s.second_name }}">
            {{ s.first_name }} {{ s.second_name }}
          </option>
          {% endfor %}
        </select>
        <input type="hidden" name="seller_name" id="seller-name">
      </div>
      
    </div>

    <div class="card">
      <div class="form-group">
        <label class="form-label">Buscar Producto</label>
        <div class="search-container">
          <input type="text" 
                id="product-search" 
                name="q" 
                placeholder="游댌 Buscar por SKU o descripci칩n..."
                hx-get="{{ url_for('api_products_search') }}"
                hx-target="#search-results"
                hx-trigger="keyup changed delay:250ms"
                hx-indicator="#search-spinner"
                autocomplete="off"
                class="search-input">
          <div class="search-indicator" id="search-spinner"></div>
        </div>
      </div>
  
      <div id="search-results" class="search-results-card"></div>
    </div>

    <div class="card">
      <h3>Detalle de Venta</h3>
      <table id="items-table">
        <thead>
          <tr>
            <th>SKU</th>
            <th>Descripci칩n</th>
            <th class="right">Precio</th>
            <th class="right">Cantidad</th>
            <th class="right">IVA</th>
            <th class="right">Importe</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="items-body">
          <!-- filas -->
        </tbody>
      </table>
    </div>

    <div class="row">
      <div class="card" style="flex:1">
        <h3>Pago</h3>
        <div class="row">
          <select name="payment_method">
            <option value="cash">Efectivo</option>
            <option value="card">Tarjeta</option>
            <option value="transfer">Transferencia</option>
          </select>
          <input type="number" step="0.01" name="payment_amount" placeholder="Monto recibido">
        </div>
      </div>
      <div class="card" style="flex:1">
        <h3>Totales</h3>
        <div class="row">
          <div>Subtotal</div><div class="right" id="t-subtotal">0.00</div>
        </div>
        <div class="row">
          <div>IVA</div><div class="right" id="t-tax">0.00</div>
        </div>
        <div class="row">
          <div><strong>Total</strong></div><div class="right" id="t-total"><strong>0.00</strong></div>
        </div>
      </div>
    </div>

    <div class="row">
      <button class="btn">Guardar e imprimir</button>
      <a class="btn secondary" href="{{ url_for('new_sale') }}">Limpiar</a>
    </div>

    <!-- campos de arrays -->
    <div id="hidden-arrays"></div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<!-- El JavaScript est치 en sales.js -->
{% endblock %}